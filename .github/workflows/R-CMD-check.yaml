name: R-CMD-check

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  R-CMD-check:
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - {os: ubuntu-latest,   r: "release"}
          - {os: macos-latest,    r: "release"}
          - {os: windows-latest,  r: "release"}

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.config.r }}

      - uses: r-lib/actions/setup-pandoc@v2

      - name: Install system deps (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update -y

      - name: Install deps from DESCRIPTION (no regex escaping)
        run: |
          Rscript -e '
            d <- read.dcf("DESCRIPTION")[1,]

            # split on commas, trim whitespace, drop version specs "(...)" without regex
            clean_pkgs <- function(x) {
              if (is.null(x) || is.na(x) || !nzchar(x)) return(character())
              x <- gsub("\n", " ", x, fixed = TRUE)
              parts <- trimws(strsplit(x, ",", fixed = TRUE)[[1]])
              parts <- parts[nzchar(parts)]
              # remove everything after first space (handles "pkg (>= 1.0.0)")
              parts <- sub(" .*", "", parts)
              parts
            }

            imports  <- clean_pkgs(d[["Imports"]])
            suggests <- clean_pkgs(d[["Suggests"]])

            # minimal suggests needed for check/vignettes
            must_suggest <- intersect(suggests, c("knitr", "rmarkdown", "testthat"))
            pkgs <- unique(c(imports, must_suggest, "rcmdcheck"))

            cat("Installing:", paste(pkgs, collapse = ", "), "\n")
            install.packages(pkgs, repos = "https://cloud.r-project.org")
          '

      - name: Verify key deps
        run: |
          Rscript -e 'stopifnot(requireNamespace("httr2", quietly=TRUE));
                      stopifnot(requireNamespace("jsonlite", quietly=TRUE));
                      stopifnot(requireNamespace("shiny", quietly=TRUE));
                      stopifnot(requireNamespace("shinyjs", quietly=TRUE));
                      cat("Verified deps OK\n")'

      - name: Check
        uses: r-lib/actions/check-r-package@v2
        with:
          upload-snapshots: true
